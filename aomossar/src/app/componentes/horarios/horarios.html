<div class="page-container">
  <header class="page-header">
    <button class="btn-back" (click)="voltar()">
      <i class="fas fa-arrow-left"></i> Voltar
    </button>
    <h2>Novo Horário de Refeição</h2>
  </header>

  <div class="content-grid" *ngIf="!loading; else loadingTpl">
    
    <!-- ERRO GERAL -->
    <div class="alert-error" *ngIf="erro">
      <i class="fas fa-exclamation-circle"></i> {{ erro }}
    </div>

    <!-- FORMULÁRIO PRINCIPAL (ESQUERDA) -->
    <section class="main-form card">
      <h3>1. Detalhes do Horário</h3>
      <form [formGroup]="formHorario">
        
        <div class="form-group">
          <label>Que horas será essa refeição?</label>
          <input type="time" formControlName="horario" class="input-lg">
        </div>

        <div class="form-group">
          <label>Qual o tipo da refeição?</label>
          <select formControlName="tipo_refeicao_id" class="input-lg">
            <option [ngValue]="null" disabled>Selecione...</option>
            <option *ngFor="let tipo of tiposRefeicao" [value]="tipo.id">
              {{ tipo.nome | titlecase }}
            </option>
          </select>
        </div>

        <div class="form-group checkbox">
          <label>
            <input type="checkbox" formControlName="criar_cardapio">
            Já quero montar o cardápio para este horário
          </label>
        </div>

      </form>
    </section>

    <!-- FORMULÁRIO DE CARDÁPIO (DIREITA - Só aparece se o checkbox estiver marcado) -->
    <section class="menu-form card" [class.disabled]="!formHorario.get('criar_cardapio')?.value">
      <h3>2. Montar Cardápio</h3>
      <p class="hint">Adicione os alimentos que farão parte desta refeição.</p>

      <!-- Form para adicionar UM alimento -->
      <form [formGroup]="formAlimento" (ngSubmit)="adicionarAlimento()" class="add-food-box">
        <div class="form-row">
          <div class="form-group">
            <label>Nome do Alimento *</label>
            <input type="text" formControlName="nome" placeholder="Ex: Arroz Branco">
          </div>
          <div class="form-group">
            <label>Qtd (g/ml) *</label>
            <input type="number" formControlName="unidade_medida" placeholder="100">
          </div>
        </div>

        <!-- Campos Opcionais (Expansível ou fixo, vou deixar fixo simples) -->
        <div class="nutri-info">
          <small>Informações Nutricionais (Opcional)</small>
          <div class="form-row nutri-grid">
            <div class="form-group grow-2">
              <input type="number" formControlName="kcal" placeholder="Kcal">
            </div>
            <div class="form-group grow-2">
              <input type="number" formControlName="proteinas" placeholder="Prot (g)">
            </div>
            <div class="form-group grow-2">
              <input type="number" formControlName="carboidratos" placeholder="Carb (g)">
            </div>
            <div class="form-group grow-2">
              <input type="number" formControlName="gordura" placeholder="Gord (g)">
            </div>
          </div>
        </div>

        <button type="submit" class="btn-add" [disabled]="formAlimento.invalid || !formHorario.get('criar_cardapio')?.value">
          <i class="fas fa-plus"></i> Adicionar ao Cardápio
        </button>
      </form>

      <!-- Lista de Alimentos Adicionados -->
      <div class="added-foods-list" *ngIf="listaAlimentos.length > 0">
        <h4>Alimentos neste cardápio ({{ listaAlimentos.length }})</h4>
        <ul>
          <li *ngFor="let item of listaAlimentos; let i = index">
            <div class="food-info">
              <strong>{{ item.nome }}</strong>
              <span>{{ item.unidade_medida }}g/ml</span>
              <span class="nutri-summary" *ngIf="item.kcal">({{ item.kcal }} kcal)</span>
            </div>
            <button type="button" class="btn-remove" (click)="removerAlimento(i)">
              <i class="fas fa-trash"></i>
            </button>
          </li>
        </ul>
      </div>
    </section>

  </div>

  <!-- FOOTER COM AÇÃO FINAL -->
  <footer class="page-footer">
    <div class="summary" *ngIf="formHorario.valid">
      Criando horário às <strong>{{ formHorario.value.horario }}</strong> 
      <span *ngIf="formHorario.value.criar_cardapio && listaAlimentos.length > 0">
        com {{ listaAlimentos.length }} alimento(s).
      </span>
    </div>
    <button class="btn-save-all" 
            (click)="salvarTudo()" 
            [disabled]="formHorario.invalid || enviando || loading">
      <i class="fas fa-spinner fa-spin" *ngIf="enviando"></i>
      {{ enviando ? 'Salvando...' : 'Salvar Planejamento' }}
    </button>
  </footer>
</div>

<ng-template #loadingTpl>
  <div class="loading-state">Carregando...</div>
</ng-template>