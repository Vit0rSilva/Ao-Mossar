<div class="dashboard-container" *ngIf="!loading; else loadingTemplate">

  <!-- ESTADO VAZIO: Se o usuário não tem NENHUM horário -->
  <div class="empty-state" *ngIf="meusHorarios.length === 0 && !erro">
    <img src="assets/illustrations/empty-plan.svg" alt="Sem plano"
      onerror="this.src='https://placehold.co/300x200/e2e8f0/64748b?text=Começar+Plano'">
    <h2>Seu plano alimentar está vazio!</h2>
    <p>Vamos começar definindo seus horários de refeição.</p>
    <button class="btn-primary-lg" routerLink="/adicionar/horario">Criar meu primeiro horário</button>
  </div>

  <!-- DASHBOARD REAL -->
  <div class="dashboard-grid" *ngIf="meusHorarios.length > 0">

    <!-- COLUNA 1: Tipos de Refeição -->
    <aside class="col-types">
      <h3>Minhas Refeições</h3>
      <p class="subtitle">O que você já planejou</p>

      <div class="types-list">
        <!-- Tipos Configurados (Ativos) -->
        <div *ngFor="let tipo of todosTiposRefeicao" class="type-item" [class.active]="tiposJaConfigurados.has(tipo.id)"
          [class.hidden]="!tiposJaConfigurados.has(tipo.id) && !expandirTipos">

          <div class="type-icon">
            <!-- Ícone dinâmico baseado no nome da refeição (simplificado) -->
            <i class="fas" [ngClass]="{
                  'fa-coffee': tipo.nome.includes('Café'),
                  'fa-sun': tipo.nome.includes('Almoço'),
                  'fa-moon': tipo.nome.includes('Jantar'),
                  'fa-apple-alt': tipo.nome.includes('Lanche') || tipo.nome.includes('Treino')
                }"></i>
          </div>
          <span class="type-name">{{ tipo.nome | titlecase }}</span>
          <i class="fas fa-check-circle status-icon" *ngIf="tiposJaConfigurados.has(tipo.id)"></i>
        </div>
      </div>

      <button class="btn-toggle-types" (click)="expandirTipos = !expandirTipos">
        {{ expandirTipos ? 'Ver menos opções' : 'Ver mais opções de refeição' }}
      </button>
    </aside>

    <!-- COLUNA 2: Linha do Tempo e Detalhes -->
    <main class="col-schedule">

      <!-- Header da seção com botão de novo horário -->
      <header class="schedule-header">
        <div>
          <h2>Seu dia alimentar</h2>
          <p *ngIf="proximoHorario">
            Próxima refeição: <strong>{{ formatarHora(proximoHorario.horario_refeicao) }} - {{
              proximoHorario.tipo_refeicao.nome | titlecase }}</strong>
          </p>
        </div>
        <button class="btn-new-schedule" routerLink="/adicionar/horario">
          <i class="fas fa-plus"></i> Novo Horário
        </button>
      </header>

      <!-- Barra de Navegação de Horários (Timeline) -->
      <div class="timeline-nav">
        <button *ngFor="let horario of meusHorarios" class="timeline-item"
          [class.selected]="horario.id === horarioSelecionado?.id" [class.is-next]="horario.id === proximoHorario?.id"
          (click)="selecionarHorario(horario)">
          <span class="time">{{ formatarHora(horario.horario_refeicao) }}</span>
          <span class="label">{{ horario.tipo_refeicao.nome }}</span>
        </button>
      </div>

      <!-- Card de Detalhe do Horário Selecionado -->
      <section class="schedule-detail-card" *ngIf="horarioSelecionado">
        <div class="card-header" [class.highlight]="horarioSelecionado.id === proximoHorario?.id">
          <div class="time-badge">
            {{ formatarHora(horarioSelecionado.horario_refeicao) }}
          </div>
          <div class="info">
            <h3>{{ horarioSelecionado.tipo_refeicao.nome | titlecase }}</h3>
            <span class="badge-next" *ngIf="horarioSelecionado.id === proximoHorario?.id">Próxima Refeição</span>
          </div>
        </div>

        <div class="card-body">
          <!-- CASO 1: Tem cardápio configurado -->
          <ng-container *ngIf="horarioSelecionado.cardapios.length > 0; else semCardapioTpl">
            <div class="menu-principal">
              <div class="d-flex justify-content-between">
                <h4 class="mb-0">Cardápio Principal</h4>

                <button class="btn-create-menu mt-0" *ngIf="getCardapioPrincipal(horarioSelecionado!)?.id"
                  (click)="abrirEdicaoCardapio(getCardapioPrincipal(horarioSelecionado!)!.id)" title="Editar cardápio">
                  <i class="fas fa-edit"></i>
                </button>
              </div>

              <ul class="food-list">
                <li *ngFor="let item of getCardapioPrincipal(horarioSelecionado)?.cardapio_alimentos">
                  <span class="food-name">{{ item.alimento.nome }}</span>
                  <span class="food-qty" *ngIf="item.alimento.unidade_medida">
                    {{ item.alimento.unidade_medida }}{{ item.alimento.unidade }}
                  </span>
                </li>
              </ul>
            </div>

            <button class="btn-create-menu" [routerLink]="['/adicionar/cardapio', horarioSelecionado.id]">
              Criar mais cardapios
            </button>



            <!-- Opções Secundárias (Expansível) -->
            <div class="secondary-menus" *ngIf="getCardapiosSecundarios(horarioSelecionado).length > 0">
              
              <button class="btn-expand-menus" (click)="expandirCardapios = !expandirCardapios">
                {{ expandirCardapios ? 'Ocultar outras opções' : 'Ver ' +
                getCardapiosSecundarios(horarioSelecionado).length + ' outra(s) opção(ões)' }}
              </button>

              <div class="expanded-list" *ngIf="expandirCardapios">
                <div *ngFor="let cardapio of getCardapiosSecundarios(horarioSelecionado); let i = index"
                  class="secondary-menu-item">
                  <div class="d-flex justify-content-between">
                    <h5>Opção {{ i + 2 }}</h5>
                    <button class="btn-create-menu mt-0" (click)="abrirEdicaoCardapio(cardapio.id)" title="Editar cardápio">
                      <i class="fas fa-edit"></i>
                    </button>
                </div>
                  <ul>
                    <li *ngFor="let item of cardapio.cardapio_alimentos">
                      {{ item.alimento.nome }}
                    </li>
                  </ul>
                  <button class="btn-make-principal" (click)="abrirModalDefinirPrincipal(cardapio)">
                    Tornar principal
                  </button>
                  
                </div>
              </div>
            </div>
          </ng-container>

          <!-- CASO 2: NÃO tem cardápio para este horário -->
          <ng-template #semCardapioTpl>
            <div class="no-menu-state">
              <i class="fas fa-utensils icon-faded"></i>
              <p>Você ainda não definiu o que comer neste horário.</p>
              <button class="btn-create-menu" [routerLink]="['/adicionar/cardapio', horarioSelecionado.id]">
                Criar Cardápio
              </button>
            </div>
          </ng-template>

        </div>
      </section>

    </main>
  </div>
</div>

<!-- Template de Carregamento -->
<ng-template #loadingTemplate>
  <div class="loading-screen">
    <div class="spinner"></div>
    <p>Carregando seu planejamento...</p>
  </div>
</ng-template>

<!-- Template de Erro -->
<div *ngIf="erro" class="error-screen">
  <i class="fas fa-exclamation-triangle"></i>
  <p>{{ erro }}</p>
  <button (click)="carregarDados()">Tentar Novamente</button>
</div>

<!-- Modal de Confirmação -->
<div class="modal-overlay" *ngIf="mostrarModal">
  <div class="modal-content">
    <h3>Definir cardápio principal</h3>
    <p>Tem certeza que deseja tornar este cardápio o principal?</p>
    <div class="modal-actions">
      <button class="btn-confirm" (click)="confirmarDefinirPrincipal()">Sim, definir</button>
      <button class="btn-cancel" (click)="fecharModal()">Cancelar</button>
    </div>
  </div>
</div>